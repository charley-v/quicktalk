import { functionOutputKey, } from '@aws-amplify/backend-output-schemas';
import { AttributionMetadataStorage } from '@aws-amplify/backend-output-storage';
import { AmplifyUserError, CallerDirectoryExtractor, TagName, } from '@aws-amplify/platform-core';
import { Duration, Stack, Tags } from 'aws-cdk-lib';
import { Rule } from 'aws-cdk-lib/aws-events';
import * as targets from 'aws-cdk-lib/aws-events-targets';
import { LayerVersion, Runtime, } from 'aws-cdk-lib/aws-lambda';
import { NodejsFunction, OutputFormat } from 'aws-cdk-lib/aws-lambda-nodejs';
import { Construct } from 'constructs';
import { readFileSync } from 'fs';
import { createRequire } from 'module';
import { fileURLToPath } from 'node:url';
import { EOL } from 'os';
import * as path from 'path';
import { FunctionEnvironmentTranslator } from './function_env_translator.js';
import { FunctionEnvironmentTypeGenerator } from './function_env_type_generator.js';
import { FunctionLayerArnParser } from './layer_parser.js';
import { convertFunctionSchedulesToRuleSchedules } from './schedule_parser.js';
const functionStackType = 'function-Lambda';
/**
 * Entry point for defining a function in the Amplify ecosystem
 */
export const defineFunction = (props = {}) => new FunctionFactory(props, new Error().stack);
/**
 * Create Lambda functions in the context of an Amplify backend definition
 */
class FunctionFactory {
    props;
    callerStack;
    generator;
    /**
     * Create a new AmplifyFunctionFactory
     */
    constructor(props, callerStack) {
        this.props = props;
        this.callerStack = callerStack;
    }
    /**
     * Creates an instance of AmplifyFunction within the provided Amplify context
     */
    getInstance = ({ constructContainer, outputStorageStrategy, resourceNameValidator, }) => {
        if (!this.generator) {
            this.generator = new FunctionGenerator(this.hydrateDefaults(resourceNameValidator), outputStorageStrategy);
        }
        return constructContainer.getOrCompute(this.generator);
    };
    hydrateDefaults = (resourceNameValidator) => {
        const name = this.resolveName();
        resourceNameValidator?.validate(name);
        const parser = new FunctionLayerArnParser();
        const layers = parser.parseLayers(this.props.layers ?? {}, name);
        return {
            name,
            entry: this.resolveEntry(),
            timeoutSeconds: this.resolveTimeout(),
            memoryMB: this.resolveMemory(),
            environment: this.props.environment ?? {},
            runtime: this.resolveRuntime(),
            schedule: this.resolveSchedule(),
            bundling: this.resolveBundling(),
            layers,
            resourceGroupName: this.props.resourceGroupName ?? 'function',
        };
    };
    resolveName = () => {
        // If name is set explicitly, use that
        if (this.props.name) {
            return this.props.name;
        }
        // If entry is set, use the basename of the entry path
        if (this.props.entry) {
            return path.parse(this.props.entry).name;
        }
        // Otherwise, use the directory name where the function is defined
        return path.basename(new CallerDirectoryExtractor(this.callerStack).extract());
    };
    resolveEntry = () => {
        // if entry is not set, default to handler.ts
        if (!this.props.entry) {
            return path.join(new CallerDirectoryExtractor(this.callerStack).extract(), 'handler.ts');
        }
        // if entry is absolute use that
        if (path.isAbsolute(this.props.entry)) {
            return this.props.entry;
        }
        // if entry is relative, compute with respect to the caller directory
        return path.join(new CallerDirectoryExtractor(this.callerStack).extract(), this.props.entry);
    };
    resolveTimeout = () => {
        const timeoutMin = 1;
        const timeoutMax = 60 * 15; // 15 minutes in seconds
        const timeoutDefault = 3;
        if (this.props.timeoutSeconds === undefined) {
            return timeoutDefault;
        }
        if (!isWholeNumberBetweenInclusive(this.props.timeoutSeconds, timeoutMin, timeoutMax)) {
            throw new Error(`timeoutSeconds must be a whole number between ${timeoutMin} and ${timeoutMax} inclusive`);
        }
        return this.props.timeoutSeconds;
    };
    resolveMemory = () => {
        const memoryMin = 128;
        const memoryMax = 10240;
        const memoryDefault = 512;
        if (this.props.memoryMB === undefined) {
            return memoryDefault;
        }
        if (!isWholeNumberBetweenInclusive(this.props.memoryMB, memoryMin, memoryMax)) {
            throw new Error(`memoryMB must be a whole number between ${memoryMin} and ${memoryMax} inclusive`);
        }
        return this.props.memoryMB;
    };
    resolveRuntime = () => {
        const runtimeDefault = 18;
        // if runtime is not set, default to the oldest LTS
        if (!this.props.runtime) {
            return runtimeDefault;
        }
        if (!(this.props.runtime in nodeVersionMap)) {
            throw new Error(`runtime must be one of the following: ${Object.keys(nodeVersionMap).join(', ')}`);
        }
        return this.props.runtime;
    };
    resolveSchedule = () => {
        if (!this.props.schedule) {
            return [];
        }
        return this.props.schedule;
    };
    resolveBundling = () => {
        const bundlingDefault = {
            format: OutputFormat.ESM,
            bundleAwsSDK: true,
            loader: {
                '.node': 'file',
            },
            minify: true,
            sourceMap: true,
        };
        return {
            ...bundlingDefault,
            minify: this.resolveMinify(this.props.bundling),
        };
    };
    resolveMinify = (bundling) => {
        return bundling?.minify === undefined ? true : bundling.minify;
    };
}
class FunctionGenerator {
    props;
    outputStorageStrategy;
    resourceGroupName;
    constructor(props, outputStorageStrategy) {
        this.props = props;
        this.outputStorageStrategy = outputStorageStrategy;
        this.resourceGroupName = props.resourceGroupName;
    }
    generateContainerEntry = ({ scope, backendSecretResolver, }) => {
        // resolve layers to LayerVersion objects for the NodejsFunction constructor using the scope.
        const resolvedLayers = Object.entries(this.props.layers).map(([key, arn]) => LayerVersion.fromLayerVersionArn(scope, `${this.props.name}-${key}-layer`, arn));
        return new AmplifyFunction(scope, this.props.name, { ...this.props, resolvedLayers }, backendSecretResolver, this.outputStorageStrategy);
    };
}
class AmplifyFunction extends Construct {
    resources;
    stack;
    functionEnvironmentTranslator;
    constructor(scope, id, props, backendSecretResolver, outputStorageStrategy) {
        super(scope, id);
        this.stack = Stack.of(scope);
        const runtime = nodeVersionMap[props.runtime];
        const require = createRequire(import.meta.url);
        const shims = runtime === Runtime.NODEJS_16_X
            ? []
            : [require.resolve('./lambda-shims/cjs_shim')];
        const ssmResolverFile = runtime === Runtime.NODEJS_16_X
            ? require.resolve('./lambda-shims/resolve_ssm_params_sdk_v2') // use aws cdk v2 in node 16
            : require.resolve('./lambda-shims/resolve_ssm_params');
        const invokeSsmResolverFile = require.resolve('./lambda-shims/invoke_ssm_shim');
        /**
         * This code concatenates the contents of the ssm resolver and invoker into a single line that can be used as the esbuild banner content
         * This banner is responsible for resolving the customer's SSM parameters at runtime
         */
        const bannerCode = readFileSync(ssmResolverFile, 'utf-8')
            .concat(readFileSync(invokeSsmResolverFile, 'utf-8'))
            .split(new RegExp(`${EOL}|\n|\r`, 'g'))
            .map((line) => line.replace(/\/\/.*$/, '')) // strip out inline comments because the banner is going to be flattened into a single line
            .join('');
        const functionEnvironmentTypeGenerator = new FunctionEnvironmentTypeGenerator(id);
        // esbuild runs as part of the NodejsFunction constructor, so we eagerly generate the process env shim without types so it can be included in the function bundle.
        // This will be overwritten with the typed file at the end of synthesis
        functionEnvironmentTypeGenerator.generateProcessEnvShim();
        let functionLambda;
        try {
            functionLambda = new NodejsFunction(scope, `${id}-lambda`, {
                entry: props.entry,
                timeout: Duration.seconds(props.timeoutSeconds),
                memorySize: props.memoryMB,
                runtime: nodeVersionMap[props.runtime],
                layers: props.resolvedLayers,
                bundling: {
                    ...props.bundling,
                    banner: bannerCode,
                    inject: shims,
                    externalModules: Object.keys(props.layers),
                },
            });
        }
        catch (error) {
            // If the error is from ES Bundler which is executed as a child process by CDK,
            // then the error from CDK contains the command that was executed along with the exit status.
            // Wrapping it here  would cause the cdk_deployer to re-throw this wrapped exception
            // instead of scraping the stderr for actual ESBuild error.
            if (error instanceof Error &&
                error.message.match(/Failed to bundle asset.*exited with status/)) {
                throw error;
            }
            throw new AmplifyUserError('NodeJSFunctionConstructInitializationError', {
                message: 'Failed to instantiate nodejs function construct',
                resolution: 'See the underlying error message for more details. Use `--debug` for additional debugging information.',
            }, error);
        }
        try {
            const schedules = convertFunctionSchedulesToRuleSchedules(functionLambda, props.schedule);
            const lambdaTarget = new targets.LambdaFunction(functionLambda);
            schedules.forEach((schedule, index) => {
                // Lambda name will be prepended to rule id, so only using index here for uniqueness
                const rule = new Rule(functionLambda, `schedule${index}`, {
                    schedule,
                });
                rule.addTarget(lambdaTarget);
            });
        }
        catch (error) {
            throw new AmplifyUserError('FunctionScheduleInitializationError', {
                message: 'Failed to instantiate schedule for nodejs function',
                resolution: 'See the underlying error message for more details.',
            }, error);
        }
        Tags.of(functionLambda).add(TagName.FRIENDLY_NAME, id);
        this.functionEnvironmentTranslator = new FunctionEnvironmentTranslator(functionLambda, props.environment, backendSecretResolver, functionEnvironmentTypeGenerator);
        this.resources = {
            lambda: functionLambda,
            cfnResources: {
                cfnFunction: functionLambda.node.findChild('Resource'),
            },
        };
        this.storeOutput(outputStorageStrategy);
        new AttributionMetadataStorage().storeAttributionMetadata(Stack.of(this), functionStackType, fileURLToPath(new URL('../package.json', import.meta.url)));
    }
    addEnvironment = (key, value) => {
        this.functionEnvironmentTranslator.addEnvironmentEntry(key, value);
    };
    getResourceAccessAcceptor = () => ({
        identifier: `${this.node.id}LambdaResourceAccessAcceptor`,
        acceptResourceAccess: (policy, ssmEnvironmentEntries) => {
            const role = this.resources.lambda.role;
            if (!role) {
                // This should never happen since we are using the Function L2 construct
                throw new Error('No execution role found to attach lambda permissions to');
            }
            policy.attachToRole(role);
            ssmEnvironmentEntries.forEach(({ name, path }) => {
                this.functionEnvironmentTranslator.addSsmEnvironmentEntry(name, path);
            });
        },
    });
    /**
     * Store storage outputs using provided strategy
     */
    storeOutput = (outputStorageStrategy) => {
        outputStorageStrategy.appendToBackendOutputList(functionOutputKey, {
            version: '1',
            payload: {
                definedFunctions: this.resources.lambda.functionName,
            },
        });
    };
}
const isWholeNumberBetweenInclusive = (test, min, max) => min <= test && test <= max && test % 1 === 0;
const nodeVersionMap = {
    16: Runtime.NODEJS_16_X,
    18: Runtime.NODEJS_18_X,
    20: Runtime.NODEJS_20_X,
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFFTCxpQkFBaUIsR0FDbEIsTUFBTSxxQ0FBcUMsQ0FBQztBQUM3QyxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUNqRixPQUFPLEVBQ0wsZ0JBQWdCLEVBQ2hCLHdCQUF3QixFQUN4QixPQUFPLEdBQ1IsTUFBTSw0QkFBNEIsQ0FBQztBQWlCcEMsT0FBTyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3BELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUM5QyxPQUFPLEtBQUssT0FBTyxNQUFNLGdDQUFnQyxDQUFDO0FBRTFELE9BQU8sRUFHTCxZQUFZLEVBQ1osT0FBTyxHQUNSLE1BQU0sd0JBQXdCLENBQUM7QUFDaEMsT0FBTyxFQUFFLGNBQWMsRUFBRSxZQUFZLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUM3RSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDbEMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUN2QyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ3pDLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDekIsT0FBTyxLQUFLLElBQUksTUFBTSxNQUFNLENBQUM7QUFDN0IsT0FBTyxFQUFFLDZCQUE2QixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDN0UsT0FBTyxFQUFFLGdDQUFnQyxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDcEYsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDM0QsT0FBTyxF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QyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFO2dCQUMvQyxJQUFJLENBQUMsNkJBQTZCLENBQUMsc0JBQXNCLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQ3hFLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztLQUNGLENBQUMsQ0FBQztJQUVIOztPQUVHO0lBQ0ssV0FBVyxHQUFHLENBQ3BCLHFCQUFtRSxFQUM3RCxFQUFFO1FBQ1IscUJBQXFCLENBQUMseUJBQXlCLENBQUMsaUJBQWlCLEVBQUU7WUFDakUsT0FBTyxFQUFFLEdBQUc7WUFDWixPQUFPLEVBQUU7Z0JBQ1AsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsWUFBWTthQUNyRDtTQUNGLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQztDQUNIO0FBRUQsTUFBTSw2QkFBNkIsR0FBRyxDQUNwQyxJQUFZLEVBQ1osR0FBVyxFQUNYLEdBQVcsRUFDWCxFQUFFLENBQUMsR0FBRyxJQUFJLElBQUksSUFBSSxJQUFJLElBQUksR0FBRyxJQUFJLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBSWxELE1BQU0sY0FBYyxHQUFpQztJQUNuRCxFQUFFLEVBQUUsT0FBTyxDQUFDLFdBQVc7SUFDdkIsRUFBRSxFQUFFLE9BQU8sQ0FBQyxXQUFXO0lBQ3ZCLEVBQUUsRUFBRSxPQUFPLENBQUMsV0FBVztDQUN4QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgRnVuY3Rpb25PdXRwdXQsXG4gIGZ1bmN0aW9uT3V0cHV0S2V5LFxufSBmcm9tICdAYXdzLWFtcGxpZnkvYmFja2VuZC1vdXRwdXQtc2NoZW1hcyc7XG5pbXBvcnQgeyBBdHRyaWJ1dGlvbk1ldGFkYXRhU3RvcmFnZSB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zdG9yYWdlJztcbmltcG9ydCB7XG4gIEFtcGxpZnlVc2VyRXJyb3IsXG4gIENhbGxlckRpcmVjdG9yeUV4dHJhY3RvcixcbiAgVGFnTmFtZSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsYXRmb3JtLWNvcmUnO1xuaW1wb3J0IHtcbiAgQW1wbGlmeVJlc291cmNlR3JvdXBOYW1lLFxuICBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5LFxuICBCYWNrZW5kU2VjcmV0LFxuICBCYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gIENvbnN0cnVjdENvbnRhaW5lckVudHJ5R2VuZXJhdG9yLFxuICBDb25zdHJ1Y3RGYWN0b3J5LFxuICBDb25zdHJ1Y3RGYWN0b3J5R2V0SW5zdGFuY2VQcm9wcyxcbiAgRnVuY3Rpb25SZXNvdXJjZXMsXG4gIEdlbmVyYXRlQ29udGFpbmVyRW50cnlQcm9wcyxcbiAgUmVzb3VyY2VBY2Nlc3NBY2NlcHRvckZhY3RvcnksXG4gIFJlc291cmNlTmFtZVZhbGlkYXRvcixcbiAgUmVzb3VyY2VQcm92aWRlcixcbiAgU3NtRW52aXJvbm1lbnRFbnRyeSxcbiAgU3RhY2tQcm92aWRlcixcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQgeyBEdXJhdGlvbiwgU3RhY2ssIFRhZ3MgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgeyBSdWxlIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWV2ZW50cyc7XG5pbXBvcnQgKiBhcyB0YXJnZXRzIGZyb20gJ2F3cy1jZGstbGliL2F3cy1ldmVudHMtdGFyZ2V0cyc7XG5pbXBvcnQgeyBQb2xpY3kgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcbmltcG9ydCB7XG4gIENmbkZ1bmN0aW9uLFxuICBJTGF5ZXJWZXJzaW9uLFxuICBMYXllclZlcnNpb24sXG4gIFJ1bnRpbWUsXG59IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgTm9kZWpzRnVuY3Rpb24sIE91dHB1dEZvcm1hdCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEtbm9kZWpzJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgcmVhZEZpbGVTeW5jIH0gZnJvbSAnZnMnO1xuaW1wb3J0IHsgY3JlYXRlUmVxdWlyZSB9IGZyb20gJ21vZHVsZSc7XG5pbXBvcnQgeyBmaWxlVVJMVG9QYXRoIH0gZnJvbSAnbm9kZTp1cmwnO1xuaW1wb3J0IHsgRU9MIH0gZnJvbSAnb3MnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IEZ1bmN0aW9uRW52aXJvbm1lbnRUcmFuc2xhdG9yIH0gZnJvbSAnLi9mdW5jdGlvbl9lbnZfdHJhbnNsYXRvci5qcyc7XG5pbXBvcnQgeyBGdW5jdGlvbkVudmlyb25tZW50VHlwZUdlbmVyYXRvciB9IGZyb20gJy4vZnVuY3Rpb25fZW52X3R5cGVfZ2VuZXJhdG9yLmpzJztcbmltcG9ydCB7IEZ1bmN0aW9uTGF5ZXJBcm5QYXJzZXIgfSBmcm9tICcuL2xheWVyX3BhcnNlci5qcyc7XG5pbXBvcnQgeyBjb252ZXJ0RnVuY3Rpb25TY2hlZHVsZXNUb1J1bGVTY2hlZHVsZXMgfSBmcm9tICcuL3NjaGVkdWxlX3BhcnNlci5qcyc7XG5cbmNvbnN0IGZ1bmN0aW9uU3RhY2tUeXBlID0gJ2Z1bmN0aW9uLUxhbWJkYSc7XG5cbmV4cG9ydCB0eXBlIEFkZEVudmlyb25tZW50RmFjdG9yeSA9IHtcbiAgYWRkRW52aXJvbm1lbnQ6IChrZXk6IHN0cmluZywgdmFsdWU6IHN0cmluZyB8IEJhY2tlbmRTZWNyZXQpID0+IHZvaWQ7XG59O1xuXG5leHBvcnQgdHlwZSBDcm9uU2NoZWR1bGUgPVxuICB8IGAke3N0cmluZ30gJHtzdHJpbmd9ICR7c3RyaW5nfSAke3N0cmluZ30gJHtzdHJpbmd9YFxuICB8IGAke3N0cmluZ30gJHtzdHJpbmd9ICR7c3RyaW5nfSAke3N0cmluZ30gJHtzdHJpbmd9ICR7c3RyaW5nfWA7XG5leHBvcnQgdHlwZSBUaW1lSW50ZXJ2YWwgPVxuICB8IGBldmVyeSAke251bWJlcn1tYFxuICB8IGBldmVyeSAke251bWJlcn1oYFxuICB8IGBldmVyeSBkYXlgXG4gIHwgYGV2ZXJ5IHdlZWtgXG4gIHwgYGV2ZXJ5IG1vbnRoYFxuICB8IGBldmVyeSB5ZWFyYDtcbmV4cG9ydCB0eXBlIEZ1bmN0aW9uU2NoZWR1bGUgPSBUaW1lSW50ZXJ2YWwgfCBDcm9uU2NoZWR1bGU7XG5cbi8qKlxuICogRW50cnkgcG9pbnQgZm9yIGRlZmluaW5nIGEgZnVuY3Rpb24gaW4gdGhlIEFtcGxpZnkgZWNvc3lzdGVtXG4gKi9cbmV4cG9ydCBjb25zdCBkZWZpbmVGdW5jdGlvbiA9IChcbiAgcHJvcHM6IEZ1bmN0aW9uUHJvcHMgPSB7fVxuKTogQ29uc3RydWN0RmFjdG9yeTxcbiAgUmVzb3VyY2VQcm92aWRlcjxGdW5jdGlvblJlc291cmNlcz4gJlxuICAgIFJlc291cmNlQWNjZXNzQWNjZXB0b3JGYWN0b3J5ICZcbiAgICBBZGRFbnZpcm9ubWVudEZhY3RvcnkgJlxuICAgIFN0YWNrUHJvdmlkZXJcbj4gPT4gbmV3IEZ1bmN0aW9uRmFjdG9yeShwcm9wcywgbmV3IEVycm9yKCkuc3RhY2spO1xuXG5leHBvcnQgdHlwZSBGdW5jdGlvblByb3BzID0ge1xuICAvKipcbiAgICogQSBuYW1lIGZvciB0aGUgZnVuY3Rpb24uXG4gICAqIERlZmF1bHRzIHRvIHRoZSBiYXNlbmFtZSBvZiB0aGUgZW50cnkgcGF0aCBpZiBzcGVjaWZpZWQuXG4gICAqIElmIG5vIGVudHJ5IGlzIHNwZWNpZmllZCwgZGVmYXVsdHMgdG8gdGhlIGRpcmVjdG9yeSBuYW1lIGluIHdoaWNoIHRoaXMgZnVuY3Rpb24gaXMgZGVmaW5lZC5cbiAgICpcbiAgICogRXhhbXBsZTpcbiAgICogSWYgZW50cnkgaXMgYC4vc2NoZWR1bGVkLWRiLWJhY2t1cC50c2AgdGhlIG5hbWUgd2lsbCBkZWZhdWx0IHRvIFwic2NoZWR1bGVkLWRiLWJhY2t1cFwiXG4gICAqIElmIGVudHJ5IGlzIG5vdCBzZXQgYW5kIHRoZSBmdW5jdGlvbiBpcyBkZWZpbmVkIGluIGBhbXBsaWZ5L2Z1bmN0aW9ucy9kYi1iYWNrdXAvcmVzb3VyY2UudHNgIHRoZSBuYW1lIHdpbGwgZGVmYXVsdCB0byBcImRiLWJhY2t1cFwiXG4gICAqL1xuICBuYW1lPzogc3RyaW5nO1xuICAvKipcbiAgICogVGhlIHBhdGggdG8gdGhlIGZpbGUgdGhhdCBjb250YWlucyB0aGUgZnVuY3Rpb24gZW50cnkgcG9pbnQuXG4gICAqIElmIHRoaXMgaXMgYSByZWxhdGl2ZSBwYXRoLCBpdCBpcyBjb21wdXRlZCByZWxhdGl2ZSB0byB0aGUgZmlsZSB3aGVyZSB0aGlzIGZ1bmN0aW9uIGlzIGRlZmluZWRcbiAgICpcbiAgICogRGVmYXVsdHMgdG8gJy4vaGFuZGxlci50cydcbiAgICovXG4gIGVudHJ5Pzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBBbiBhbW91bnQgb2YgdGltZSBpbiBzZWNvbmRzIGJldHdlZW4gMSBzZWNvbmQgYW5kIDE1IG1pbnV0ZXMuXG4gICAqIE11c3QgYmUgYSB3aG9sZSBudW1iZXIuXG4gICAqIERlZmF1bHQgaXMgMyBzZWNvbmRzLlxuICAgKi9cbiAgdGltZW91dFNlY29uZHM/OiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIEFuIGFtb3VudCBvZiBtZW1vcnkgKFJBTSkgdG8gYWxsb2NhdGUgdG8gdGhlIGZ1bmN0aW9uIGJldHdlZW4gMTI4IGFuZCAxMDI0MCBNQi5cbiAgICogTXVzdCBiZSBhIHdob2xlIG51bWJlci5cbiAgICogRGVmYXVsdCBpcyA1MTJNQi5cbiAgICovXG4gIG1lbW9yeU1CPzogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBFbnZpcm9ubWVudCB2YXJpYWJsZXMgdGhhdCB3aWxsIGJlIGF2YWlsYWJsZSBkdXJpbmcgZnVuY3Rpb24gZXhlY3V0aW9uXG4gICAqL1xuICBlbnZpcm9ubWVudD86IFJlY29yZDxzdHJpbmcsIHN0cmluZyB8IEJhY2tlbmRTZWNyZXQ+O1xuXG4gIC8qKlxuICAgKiBOb2RlIHJ1bnRpbWUgdmVyc2lvbiBmb3IgdGhlIGxhbWJkYSBlbnZpcm9ubWVudC5cbiAgICpcbiAgICogRGVmYXVsdHMgdG8gdGhlIG9sZGVzdCBOb2RlSlMgTFRTIHZlcnNpb24uIFNlZSBodHRwczovL25vZGVqcy5vcmcvZW4vYWJvdXQvcHJldmlvdXMtcmVsZWFzZXNcbiAgICovXG4gIHJ1bnRpbWU/OiBOb2RlVmVyc2lvbjtcblxuICAvKipcbiAgICogQSB0aW1lIGludGVydmFsIHN0cmluZyB0byBwZXJpb2RpY2FsbHkgcnVuIHRoZSBmdW5jdGlvbi5cbiAgICogVGhpcyBjYW4gYmUgZWl0aGVyIGEgc3RyaW5nIG9mIGBcImV2ZXJ5IDxwb3NpdGl2ZSB3aG9sZSBudW1iZXI+PG0gKG1pbnV0ZSkgb3IgaCAoaG91cik+XCJgLCBgXCJldmVyeSBkYXl8d2Vla3xtb250aHx5ZWFyXCJgIG9yIGNyb24gZXhwcmVzc2lvbi5cbiAgICogRGVmYXVsdHMgdG8gbm8gc2NoZWR1bGluZyBmb3IgdGhlIGZ1bmN0aW9uLlxuICAgKiBAZXhhbXBsZVxuICAgKiBzY2hlZHVsZTogXCJldmVyeSA1bVwiXG4gICAqIEBleGFtcGxlXG4gICAqIHNjaGVkdWxlOiBcImV2ZXJ5IHdlZWtcIlxuICAgKiBAZXhhbXBsZVxuICAgKiBzY2hlZHVsZTogXCIwIDkgPyAqIDIgKlwiIC8vIGV2ZXJ5IE1vbmRheSBhdCA5YW1cbiAgICovXG4gIHNjaGVkdWxlPzogRnVuY3Rpb25TY2hlZHVsZSB8IEZ1bmN0aW9uU2NoZWR1bGVbXTtcblxuICAvKipcbiAgICogQXR0YWNoIExhbWJkYSBsYXllcnMgdG8gYSBmdW5jdGlvblxuICAgKiAtIEEgTGFtYmRhIGxheWVyIGlzIHJlcHJlc2VudGVkIGJ5IGFuIG9iamVjdCBvZiBrZXkvdmFsdWUgcGFpciB3aGVyZSB0aGUga2V5IGlzIHRoZSBtb2R1bGUgbmFtZSB0aGF0IGlzIGV4cG9ydGVkIGZyb20geW91ciBsYXllciBhbmQgdGhlIHZhbHVlIGlzIHRoZSBBUk4gb2YgdGhlIGxheWVyLiBUaGUga2V5IChtb2R1bGUgbmFtZSkgaXMgdXNlZCB0byBleHRlcm5hbGl6ZSB0aGUgbW9kdWxlIGRlcGVuZGVuY3kgc28gaXQgZG9lc24ndCBnZXQgYnVuZGxlZCB3aXRoIHlvdXIgbGFtYmRhIGZ1bmN0aW9uXG4gICAqIC0gTWF4aW11bSBvZiA1IGxheWVycyBjYW4gYmUgYXR0YWNoZWQgdG8gYSBmdW5jdGlvbiBhbmQgbXVzdCBiZSBpbiB0aGUgc2FtZSByZWdpb24gYXMgdGhlIGZ1bmN0aW9uLlxuICAgKiBAZXhhbXBsZVxuICAgKiBsYXllcnM6IHtcbiAgICogICAgXCJAYXdzLWxhbWJkYS1wb3dlcnRvb2xzL2xvZ2dlclwiOiBcImFybjphd3M6bGFtYmRhOjxjdXJyZW50LXJlZ2lvbj46MDk0Mjc0MTA1OTE1OmxheWVyOkFXU0xhbWJkYVBvd2VydG9vbHNUeXBlU2NyaXB0VjI6MTFcIlxuICAgKiB9LFxuICAgKiBAc2VlIFtBbXBsaWZ5IGRvY3VtZW50YXRpb24gZm9yIExhbWJkYSBsYXllcnNdKGh0dHBzOi8vZG9jcy5hbXBsaWZ5LmF3cy9yZWFjdC9idWlsZC1hLWJhY2tlbmQvZnVuY3Rpb25zL2FkZC1sYW1iZGEtbGF5ZXJzKVxuICAgKiBAc2VlIFtBV1MgZG9jdW1lbnRhdGlvbiBmb3IgTGFtYmRhIGxheWVyc10oaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2xhbWJkYS9sYXRlc3QvZGcvY2hhcHRlci1sYXllcnMuaHRtbClcbiAgICovXG4gIGxheWVycz86IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG5cbiAgLypcbiAgICogT3B0aW9ucyBmb3IgYnVuZGxpbmcgdGhlIGZ1bmN0aW9uIGNvZGUuXG4gICAqL1xuICBidW5kbGluZz86IEZ1bmN0aW9uQnVuZGxpbmdPcHRpb25zO1xuXG4gIC8qKlxuICAgKiBHcm91cCB0aGUgZnVuY3Rpb24gd2l0aCBleGlzdGluZyBBbXBsaWZ5IHJlc291cmNlcyBvciBzZXBhcmF0ZSB0aGUgZnVuY3Rpb24gaW50byBpdHMgb3duIGdyb3VwLlxuICAgKiBAZGVmYXVsdCAnZnVuY3Rpb24nIC8vIGdyb3VwaW5nIHdpdGggb3RoZXIgQW1wbGlmeSBmdW5jdGlvbnNcbiAgICogQGV4YW1wbGVcbiAgICogcmVzb3VyY2VHcm91cE5hbWU6ICdhdXRoJyAvLyB0byBncm91cCBhbiBhdXRoIHRyaWdnZXIgd2l0aCBhbiBhdXRoIHJlc291cmNlXG4gICAqL1xuICByZXNvdXJjZUdyb3VwTmFtZT86IEFtcGxpZnlSZXNvdXJjZUdyb3VwTmFtZTtcbn07XG5cbmV4cG9ydCB0eXBlIEZ1bmN0aW9uQnVuZGxpbmdPcHRpb25zID0ge1xuICAvKipcbiAgICogV2hldGhlciB0byBtaW5pZnkgdGhlIGZ1bmN0aW9uIGNvZGUuXG4gICAqXG4gICAqIERlZmF1bHRzIHRvIHRydWUuXG4gICAqL1xuICBtaW5pZnk/OiBib29sZWFuO1xufTtcblxuLyoqXG4gKiBDcmVhdGUgTGFtYmRhIGZ1bmN0aW9ucyBpbiB0aGUgY29udGV4dCBvZiBhbiBBbXBsaWZ5IGJhY2tlbmQgZGVmaW5pdGlvblxuICovXG5jbGFzcyBGdW5jdGlvbkZhY3RvcnkgaW1wbGVtZW50cyBDb25zdHJ1Y3RGYWN0b3J5PEFtcGxpZnlGdW5jdGlvbj4ge1xuICBwcml2YXRlIGdlbmVyYXRvcjogQ29uc3RydWN0Q29udGFpbmVyRW50cnlHZW5lcmF0b3I7XG4gIC8qKlxuICAgKiBDcmVhdGUgYSBuZXcgQW1wbGlmeUZ1bmN0aW9uRmFjdG9yeVxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcm9wczogRnVuY3Rpb25Qcm9wcyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNhbGxlclN0YWNrPzogc3RyaW5nXG4gICkge31cblxuICAvKipcbiAgICogQ3JlYXRlcyBhbiBpbnN0YW5jZSBvZiBBbXBsaWZ5RnVuY3Rpb24gd2l0aGluIHRoZSBwcm92aWRlZCBBbXBsaWZ5IGNvbnRleHRcbiAgICovXG4gIGdldEluc3RhbmNlID0gKHtcbiAgICBjb25zdHJ1Y3RDb250YWluZXIsXG4gICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5LFxuICAgIHJlc291cmNlTmFtZVZhbGlkYXRvcixcbiAgfTogQ29uc3RydWN0RmFjdG9yeUdldEluc3RhbmNlUHJvcHMpOiBBbXBsaWZ5RnVuY3Rpb24gPT4ge1xuICAgIGlmICghdGhpcy5nZW5lcmF0b3IpIHtcbiAgICAgIHRoaXMuZ2VuZXJhdG9yID0gbmV3IEZ1bmN0aW9uR2VuZXJhdG9yKFxuICAgICAgICB0aGlzLmh5ZHJhdGVEZWZhdWx0cyhyZXNvdXJjZU5hbWVWYWxpZGF0b3IpLFxuICAgICAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3lcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBjb25zdHJ1Y3RDb250YWluZXIuZ2V0T3JDb21wdXRlKHRoaXMuZ2VuZXJhdG9yKSBhcyBBbXBsaWZ5RnVuY3Rpb247XG4gIH07XG5cbiAgcHJpdmF0ZSBoeWRyYXRlRGVmYXVsdHMgPSAoXG4gICAgcmVzb3VyY2VOYW1lVmFsaWRhdG9yPzogUmVzb3VyY2VOYW1lVmFsaWRhdG9yXG4gICk6IEh5ZHJhdGVkRnVuY3Rpb25Qcm9wcyA9PiB7XG4gICAgY29uc3QgbmFtZSA9IHRoaXMucmVzb2x2ZU5hbWUoKTtcbiAgICByZXNvdXJjZU5hbWVWYWxpZGF0b3I/LnZhbGlkYXRlKG5hbWUpO1xuICAgIGNvbnN0IHBhcnNlciA9IG5ldyBGdW5jdGlvbkxheWVyQXJuUGFyc2VyKCk7XG4gICAgY29uc3QgbGF5ZXJzID0gcGFyc2VyLnBhcnNlTGF5ZXJzKHRoaXMucHJvcHMubGF5ZXJzID8/IHt9LCBuYW1lKTtcbiAgICByZXR1cm4ge1xuICAgICAgbmFtZSxcbiAgICAgIGVudHJ5OiB0aGlzLnJlc29sdmVFbnRyeSgpLFxuICAgICAgdGltZW91dFNlY29uZHM6IHRoaXMucmVzb2x2ZVRpbWVvdXQoKSxcbiAgICAgIG1lbW9yeU1COiB0aGlzLnJlc29sdmVNZW1vcnkoKSxcbiAgICAgIGVudmlyb25tZW50OiB0aGlzLnByb3BzLmVudmlyb25tZW50ID8/IHt9LFxuICAgICAgcnVudGltZTogdGhpcy5yZXNvbHZlUnVudGltZSgpLFxuICAgICAgc2NoZWR1bGU6IHRoaXMucmVzb2x2ZVNjaGVkdWxlKCksXG4gICAgICBidW5kbGluZzogdGhpcy5yZXNvbHZlQnVuZGxpbmcoKSxcbiAgICAgIGxheWVycyxcbiAgICAgIHJlc291cmNlR3JvdXBOYW1lOiB0aGlzLnByb3BzLnJlc291cmNlR3JvdXBOYW1lID8/ICdmdW5jdGlvbicsXG4gICAgfTtcbiAgfTtcblxuICBwcml2YXRlIHJlc29sdmVOYW1lID0gKCkgPT4ge1xuICAgIC8vIElmIG5hbWUgaXMgc2V0IGV4cGxpY2l0bHksIHVzZSB0aGF0XG4gICAgaWYgKHRoaXMucHJvcHMubmFtZSkge1xuICAgICAgcmV0dXJuIHRoaXMucHJvcHMubmFtZTtcbiAgICB9XG4gICAgLy8gSWYgZW50cnkgaXMgc2V0LCB1c2UgdGhlIGJhc2VuYW1lIG9mIHRoZSBlbnRyeSBwYXRoXG4gICAgaWYgKHRoaXMucHJvcHMuZW50cnkpIHtcbiAgICAgIHJldHVybiBwYXRoLnBhcnNlKHRoaXMucHJvcHMuZW50cnkpLm5hbWU7XG4gICAgfVxuXG4gICAgLy8gT3RoZXJ3aXNlLCB1c2UgdGhlIGRpcmVjdG9yeSBuYW1lIHdoZXJlIHRoZSBmdW5jdGlvbiBpcyBkZWZpbmVkXG4gICAgcmV0dXJuIHBhdGguYmFzZW5hbWUoXG4gICAgICBuZXcgQ2FsbGVyRGlyZWN0b3J5RXh0cmFjdG9yKHRoaXMuY2FsbGVyU3RhY2spLmV4dHJhY3QoKVxuICAgICk7XG4gIH07XG5cbiAgcHJpdmF0ZSByZXNvbHZlRW50cnkgPSAoKSA9PiB7XG4gICAgLy8gaWYgZW50cnkgaXMgbm90IHNldCwgZGVmYXVsdCB0byBoYW5kbGVyLnRzXG4gICAgaWYgKCF0aGlzLnByb3BzLmVudHJ5KSB7XG4gICAgICByZXR1cm4gcGF0aC5qb2luKFxuICAgICAgICBuZXcgQ2FsbGVyRGlyZWN0b3J5RXh0cmFjdG9yKHRoaXMuY2FsbGVyU3RhY2spLmV4dHJhY3QoKSxcbiAgICAgICAgJ2hhbmRsZXIudHMnXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIGlmIGVudHJ5IGlzIGFic29sdXRlIHVzZSB0aGF0XG4gICAgaWYgKHBhdGguaXNBYnNvbHV0ZSh0aGlzLnByb3BzLmVudHJ5KSkge1xuICAgICAgcmV0dXJuIHRoaXMucHJvcHMuZW50cnk7XG4gICAgfVxuXG4gICAgLy8gaWYgZW50cnkgaXMgcmVsYXRpdmUsIGNvbXB1dGUgd2l0aCByZXNwZWN0IHRvIHRoZSBjYWxsZXIgZGlyZWN0b3J5XG4gICAgcmV0dXJuIHBhdGguam9pbihcbiAgICAgIG5ldyBDYWxsZXJEaXJlY3RvcnlFeHRyYWN0b3IodGhpcy5jYWxsZXJTdGFjaykuZXh0cmFjdCgpLFxuICAgICAgdGhpcy5wcm9wcy5lbnRyeVxuICAgICk7XG4gIH07XG5cbiAgcHJpdmF0ZSByZXNvbHZlVGltZW91dCA9ICgpID0+IHtcbiAgICBjb25zdCB0aW1lb3V0TWluID0gMTtcbiAgICBjb25zdCB0aW1lb3V0TWF4ID0gNjAgKiAxNTsgLy8gMTUgbWludXRlcyBpbiBzZWNvbmRzXG4gICAgY29uc3QgdGltZW91dERlZmF1bHQgPSAzO1xuICAgIGlmICh0aGlzLnByb3BzLnRpbWVvdXRTZWNvbmRzID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiB0aW1lb3V0RGVmYXVsdDtcbiAgICB9XG5cbiAgICBpZiAoXG4gICAgICAhaXNXaG9sZU51bWJlckJldHdlZW5JbmNsdXNpdmUoXG4gICAgICAgIHRoaXMucHJvcHMudGltZW91dFNlY29uZHMsXG4gICAgICAgIHRpbWVvdXRNaW4sXG4gICAgICAgIHRpbWVvdXRNYXhcbiAgICAgIClcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYHRpbWVvdXRTZWNvbmRzIG11c3QgYmUgYSB3aG9sZSBudW1iZXIgYmV0d2VlbiAke3RpbWVvdXRNaW59IGFuZCAke3RpbWVvdXRNYXh9IGluY2x1c2l2ZWBcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnByb3BzLnRpbWVvdXRTZWNvbmRzO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZU1lbW9yeSA9ICgpID0+IHtcbiAgICBjb25zdCBtZW1vcnlNaW4gPSAxMjg7XG4gICAgY29uc3QgbWVtb3J5TWF4ID0gMTAyNDA7XG4gICAgY29uc3QgbWVtb3J5RGVmYXVsdCA9IDUxMjtcbiAgICBpZiAodGhpcy5wcm9wcy5tZW1vcnlNQiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gbWVtb3J5RGVmYXVsdDtcbiAgICB9XG4gICAgaWYgKFxuICAgICAgIWlzV2hvbGVOdW1iZXJCZXR3ZWVuSW5jbHVzaXZlKHRoaXMucHJvcHMubWVtb3J5TUIsIG1lbW9yeU1pbiwgbWVtb3J5TWF4KVxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgbWVtb3J5TUIgbXVzdCBiZSBhIHdob2xlIG51bWJlciBiZXR3ZWVuICR7bWVtb3J5TWlufSBhbmQgJHttZW1vcnlNYXh9IGluY2x1c2l2ZWBcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnByb3BzLm1lbW9yeU1CO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZVJ1bnRpbWUgPSAoKSA9PiB7XG4gICAgY29uc3QgcnVudGltZURlZmF1bHQgPSAxODtcblxuICAgIC8vIGlmIHJ1bnRpbWUgaXMgbm90IHNldCwgZGVmYXVsdCB0byB0aGUgb2xkZXN0IExUU1xuICAgIGlmICghdGhpcy5wcm9wcy5ydW50aW1lKSB7XG4gICAgICByZXR1cm4gcnVudGltZURlZmF1bHQ7XG4gICAgfVxuXG4gICAgaWYgKCEodGhpcy5wcm9wcy5ydW50aW1lIGluIG5vZGVWZXJzaW9uTWFwKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgcnVudGltZSBtdXN0IGJlIG9uZSBvZiB0aGUgZm9sbG93aW5nOiAke09iamVjdC5rZXlzKFxuICAgICAgICAgIG5vZGVWZXJzaW9uTWFwXG4gICAgICAgICkuam9pbignLCAnKX1gXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnByb3BzLnJ1bnRpbWU7XG4gIH07XG5cbiAgcHJpdmF0ZSByZXNvbHZlU2NoZWR1bGUgPSAoKSA9PiB7XG4gICAgaWYgKCF0aGlzLnByb3BzLnNjaGVkdWxlKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMucHJvcHMuc2NoZWR1bGU7XG4gIH07XG5cbiAgcHJpdmF0ZSByZXNvbHZlQnVuZGxpbmcgPSAoKSA9PiB7XG4gICAgY29uc3QgYnVuZGxpbmdEZWZhdWx0ID0ge1xuICAgICAgZm9ybWF0OiBPdXRwdXRGb3JtYXQuRVNNLFxuICAgICAgYnVuZGxlQXdzU0RLOiB0cnVlLFxuICAgICAgbG9hZGVyOiB7XG4gICAgICAgICcubm9kZSc6ICdmaWxlJyxcbiAgICAgIH0sXG4gICAgICBtaW5pZnk6IHRydWUsXG4gICAgICBzb3VyY2VNYXA6IHRydWUsXG4gICAgfTtcblxuICAgIHJldHVybiB7XG4gICAgICAuLi5idW5kbGluZ0RlZmF1bHQsXG4gICAgICBtaW5pZnk6IHRoaXMucmVzb2x2ZU1pbmlmeSh0aGlzLnByb3BzLmJ1bmRsaW5nKSxcbiAgICB9O1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZU1pbmlmeSA9IChidW5kbGluZz86IEZ1bmN0aW9uQnVuZGxpbmdPcHRpb25zKSA9PiB7XG4gICAgcmV0dXJuIGJ1bmRsaW5nPy5taW5pZnkgPT09IHVuZGVmaW5lZCA/IHRydWUgOiBidW5kbGluZy5taW5pZnk7XG4gIH07XG59XG5cbnR5cGUgSHlkcmF0ZWRGdW5jdGlvblByb3BzID0gUmVxdWlyZWQ8RnVuY3Rpb25Qcm9wcz47XG5cbmNsYXNzIEZ1bmN0aW9uR2VuZXJhdG9yIGltcGxlbWVudHMgQ29uc3RydWN0Q29udGFpbmVyRW50cnlHZW5lcmF0b3Ige1xuICByZWFkb25seSByZXNvdXJjZUdyb3VwTmFtZTogQW1wbGlmeVJlc291cmNlR3JvdXBOYW1lO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJvcHM6IEh5ZHJhdGVkRnVuY3Rpb25Qcm9wcyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IG91dHB1dFN0b3JhZ2VTdHJhdGVneTogQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneTxGdW5jdGlvbk91dHB1dD5cbiAgKSB7XG4gICAgdGhpcy5yZXNvdXJjZUdyb3VwTmFtZSA9IHByb3BzLnJlc291cmNlR3JvdXBOYW1lO1xuICB9XG5cbiAgZ2VuZXJhdGVDb250YWluZXJFbnRyeSA9ICh7XG4gICAgc2NvcGUsXG4gICAgYmFja2VuZFNlY3JldFJlc29sdmVyLFxuICB9OiBHZW5lcmF0ZUNvbnRhaW5lckVudHJ5UHJvcHMpID0+IHtcbiAgICAvLyByZXNvbHZlIGxheWVycyB0byBMYXllclZlcnNpb24gb2JqZWN0cyBmb3IgdGhlIE5vZGVqc0Z1bmN0aW9uIGNvbnN0cnVjdG9yIHVzaW5nIHRoZSBzY29wZS5cbiAgICBjb25zdCByZXNvbHZlZExheWVycyA9IE9iamVjdC5lbnRyaWVzKHRoaXMucHJvcHMubGF5ZXJzKS5tYXAoKFtrZXksIGFybl0pID0+XG4gICAgICBMYXllclZlcnNpb24uZnJvbUxheWVyVmVyc2lvbkFybihcbiAgICAgICAgc2NvcGUsXG4gICAgICAgIGAke3RoaXMucHJvcHMubmFtZX0tJHtrZXl9LWxheWVyYCxcbiAgICAgICAgYXJuXG4gICAgICApXG4gICAgKTtcblxuICAgIHJldHVybiBuZXcgQW1wbGlmeUZ1bmN0aW9uKFxuICAgICAgc2NvcGUsXG4gICAgICB0aGlzLnByb3BzLm5hbWUsXG4gICAgICB7IC4uLnRoaXMucHJvcHMsIHJlc29sdmVkTGF5ZXJzIH0sXG4gICAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gICAgICB0aGlzLm91dHB1dFN0b3JhZ2VTdHJhdGVneVxuICAgICk7XG4gIH07XG59XG5cbmNsYXNzIEFtcGxpZnlGdW5jdGlvblxuICBleHRlbmRzIENvbnN0cnVjdFxuICBpbXBsZW1lbnRzXG4gICAgUmVzb3VyY2VQcm92aWRlcjxGdW5jdGlvblJlc291cmNlcz4sXG4gICAgUmVzb3VyY2VBY2Nlc3NBY2NlcHRvckZhY3RvcnksXG4gICAgQWRkRW52aXJvbm1lbnRGYWN0b3J5XG57XG4gIHJlYWRvbmx5IHJlc291cmNlczogRnVuY3Rpb25SZXNvdXJjZXM7XG4gIHJlYWRvbmx5IHN0YWNrOiBTdGFjaztcbiAgcHJpdmF0ZSByZWFkb25seSBmdW5jdGlvbkVudmlyb25tZW50VHJhbnNsYXRvcjogRnVuY3Rpb25FbnZpcm9ubWVudFRyYW5zbGF0b3I7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgaWQ6IHN0cmluZyxcbiAgICBwcm9wczogSHlkcmF0ZWRGdW5jdGlvblByb3BzICYgeyByZXNvbHZlZExheWVyczogSUxheWVyVmVyc2lvbltdIH0sXG4gICAgYmFja2VuZFNlY3JldFJlc29sdmVyOiBCYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5OiBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5PEZ1bmN0aW9uT3V0cHV0PlxuICApIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgdGhpcy5zdGFjayA9IFN0YWNrLm9mKHNjb3BlKTtcblxuICAgIGNvbnN0IHJ1bnRpbWUgPSBub2RlVmVyc2lvbk1hcFtwcm9wcy5ydW50aW1lXTtcblxuICAgIGNvbnN0IHJlcXVpcmUgPSBjcmVhdGVSZXF1aXJlKGltcG9ydC5tZXRhLnVybCk7XG5cbiAgICBjb25zdCBzaGltcyA9XG4gICAgICBydW50aW1lID09PSBSdW50aW1lLk5PREVKU18xNl9YXG4gICAgICAgID8gW11cbiAgICAgICAgOiBbcmVxdWlyZS5yZXNvbHZlKCcuL2xhbWJkYS1zaGltcy9janNfc2hpbScpXTtcblxuICAgIGNvbnN0IHNzbVJlc29sdmVyRmlsZSA9XG4gICAgICBydW50aW1lID09PSBSdW50aW1lLk5PREVKU18xNl9YXG4gICAgICAgID8gcmVxdWlyZS5yZXNvbHZlKCcuL2xhbWJkYS1zaGltcy9yZXNvbHZlX3NzbV9wYXJhbXNfc2RrX3YyJykgLy8gdXNlIGF3cyBjZGsgdjIgaW4gbm9kZSAxNlxuICAgICAgICA6IHJlcXVpcmUucmVzb2x2ZSgnLi9sYW1iZGEtc2hpbXMvcmVzb2x2ZV9zc21fcGFyYW1zJyk7XG5cbiAgICBjb25zdCBpbnZva2VTc21SZXNvbHZlckZpbGUgPSByZXF1aXJlLnJlc29sdmUoXG4gICAgICAnLi9sYW1iZGEtc2hpbXMvaW52b2tlX3NzbV9zaGltJ1xuICAgICk7XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGNvZGUgY29uY2F0ZW5hdGVzIHRoZSBjb250ZW50cyBvZiB0aGUgc3NtIHJlc29sdmVyIGFuZCBpbnZva2VyIGludG8gYSBzaW5nbGUgbGluZSB0aGF0IGNhbiBiZSB1c2VkIGFzIHRoZSBlc2J1aWxkIGJhbm5lciBjb250ZW50XG4gICAgICogVGhpcyBiYW5uZXIgaXMgcmVzcG9uc2libGUgZm9yIHJlc29sdmluZyB0aGUgY3VzdG9tZXIncyBTU00gcGFyYW1ldGVycyBhdCBydW50aW1lXG4gICAgICovXG4gICAgY29uc3QgYmFubmVyQ29kZSA9IHJlYWRGaWxlU3luYyhzc21SZXNvbHZlckZpbGUsICd1dGYtOCcpXG4gICAgICAuY29uY2F0KHJlYWRGaWxlU3luYyhpbnZva2VTc21SZXNvbHZlckZpbGUsICd1dGYtOCcpKVxuICAgICAgLnNwbGl0KG5ldyBSZWdFeHAoYCR7RU9MfXxcXG58XFxyYCwgJ2cnKSlcbiAgICAgIC5tYXAoKGxpbmUpID0+IGxpbmUucmVwbGFjZSgvXFwvXFwvLiokLywgJycpKSAvLyBzdHJpcCBvdXQgaW5saW5lIGNvbW1lbnRzIGJlY2F1c2UgdGhlIGJhbm5lciBpcyBnb2luZyB0byBiZSBmbGF0dGVuZWQgaW50byBhIHNpbmdsZSBsaW5lXG4gICAgICAuam9pbignJyk7XG5cbiAgICBjb25zdCBmdW5jdGlvbkVudmlyb25tZW50VHlwZUdlbmVyYXRvciA9XG4gICAgICBuZXcgRnVuY3Rpb25FbnZpcm9ubWVudFR5cGVHZW5lcmF0b3IoaWQpO1xuXG4gICAgLy8gZXNidWlsZCBydW5zIGFzIHBhcnQgb2YgdGhlIE5vZGVqc0Z1bmN0aW9uIGNvbnN0cnVjdG9yLCBzbyB3ZSBlYWdlcmx5IGdlbmVyYXRlIHRoZSBwcm9jZXNzIGVudiBzaGltIHdpdGhvdXQgdHlwZXMgc28gaXQgY2FuIGJlIGluY2x1ZGVkIGluIHRoZSBmdW5jdGlvbiBidW5kbGUuXG4gICAgLy8gVGhpcyB3aWxsIGJlIG92ZXJ3cml0dGVuIHdpdGggdGhlIHR5cGVkIGZpbGUgYXQgdGhlIGVuZCBvZiBzeW50aGVzaXNcbiAgICBmdW5jdGlvbkVudmlyb25tZW50VHlwZUdlbmVyYXRvci5nZW5lcmF0ZVByb2Nlc3NFbnZTaGltKCk7XG5cbiAgICBsZXQgZnVuY3Rpb25MYW1iZGE6IE5vZGVqc0Z1bmN0aW9uO1xuICAgIHRyeSB7XG4gICAgICBmdW5jdGlvbkxhbWJkYSA9IG5ldyBOb2RlanNGdW5jdGlvbihzY29wZSwgYCR7aWR9LWxhbWJkYWAsIHtcbiAgICAgICAgZW50cnk6IHByb3BzLmVudHJ5LFxuICAgICAgICB0aW1lb3V0OiBEdXJhdGlvbi5zZWNvbmRzKHByb3BzLnRpbWVvdXRTZWNvbmRzKSxcbiAgICAgICAgbWVtb3J5U2l6ZTogcHJvcHMubWVtb3J5TUIsXG4gICAgICAgIHJ1bnRpbWU6IG5vZGVWZXJzaW9uTWFwW3Byb3BzLnJ1bnRpbWVdLFxuICAgICAgICBsYXllcnM6IHByb3BzLnJlc29sdmVkTGF5ZXJzLFxuICAgICAgICBidW5kbGluZzoge1xuICAgICAgICAgIC4uLnByb3BzLmJ1bmRsaW5nLFxuICAgICAgICAgIGJhbm5lcjogYmFubmVyQ29kZSxcbiAgICAgICAgICBpbmplY3Q6IHNoaW1zLFxuICAgICAgICAgIGV4dGVybmFsTW9kdWxlczogT2JqZWN0LmtleXMocHJvcHMubGF5ZXJzKSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAvLyBJZiB0aGUgZXJyb3IgaXMgZnJvbSBFUyBCdW5kbGVyIHdoaWNoIGlzIGV4ZWN1dGVkIGFzIGEgY2hpbGQgcHJvY2VzcyBieSBDREssXG4gICAgICAvLyB0aGVuIHRoZSBlcnJvciBmcm9tIENESyBjb250YWlucyB0aGUgY29tbWFuZCB0aGF0IHdhcyBleGVjdXRlZCBhbG9uZyB3aXRoIHRoZSBleGl0IHN0YXR1cy5cbiAgICAgIC8vIFdyYXBwaW5nIGl0IGhlcmUgIHdvdWxkIGNhdXNlIHRoZSBjZGtfZGVwbG95ZXIgdG8gcmUtdGhyb3cgdGhpcyB3cmFwcGVkIGV4Y2VwdGlvblxuICAgICAgLy8gaW5zdGVhZCBvZiBzY3JhcGluZyB0aGUgc3RkZXJyIGZvciBhY3R1YWwgRVNCdWlsZCBlcnJvci5cbiAgICAgIGlmIChcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciAmJlxuICAgICAgICBlcnJvci5tZXNzYWdlLm1hdGNoKC9GYWlsZWQgdG8gYnVuZGxlIGFzc2V0LipleGl0ZWQgd2l0aCBzdGF0dXMvKVxuICAgICAgKSB7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICdOb2RlSlNGdW5jdGlvbkNvbnN0cnVjdEluaXRpYWxpemF0aW9uRXJyb3InLFxuICAgICAgICB7XG4gICAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBpbnN0YW50aWF0ZSBub2RlanMgZnVuY3Rpb24gY29uc3RydWN0JyxcbiAgICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICAgJ1NlZSB0aGUgdW5kZXJseWluZyBlcnJvciBtZXNzYWdlIGZvciBtb3JlIGRldGFpbHMuIFVzZSBgLS1kZWJ1Z2AgZm9yIGFkZGl0aW9uYWwgZGVidWdnaW5nIGluZm9ybWF0aW9uLicsXG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yIGFzIEVycm9yXG4gICAgICApO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBzY2hlZHVsZXMgPSBjb252ZXJ0RnVuY3Rpb25TY2hlZHVsZXNUb1J1bGVTY2hlZHVsZXMoXG4gICAgICAgIGZ1bmN0aW9uTGFtYmRhLFxuICAgICAgICBwcm9wcy5zY2hlZHVsZVxuICAgICAgKTtcbiAgICAgIGNvbnN0IGxhbWJkYVRhcmdldCA9IG5ldyB0YXJnZXRzLkxhbWJkYUZ1bmN0aW9uKGZ1bmN0aW9uTGFtYmRhKTtcblxuICAgICAgc2NoZWR1bGVzLmZvckVhY2goKHNjaGVkdWxlLCBpbmRleCkgPT4ge1xuICAgICAgICAvLyBMYW1iZGEgbmFtZSB3aWxsIGJlIHByZXBlbmRlZCB0byBydWxlIGlkLCBzbyBvbmx5IHVzaW5nIGluZGV4IGhlcmUgZm9yIHVuaXF1ZW5lc3NcbiAgICAgICAgY29uc3QgcnVsZSA9IG5ldyBSdWxlKGZ1bmN0aW9uTGFtYmRhLCBgc2NoZWR1bGUke2luZGV4fWAsIHtcbiAgICAgICAgICBzY2hlZHVsZSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcnVsZS5hZGRUYXJnZXQobGFtYmRhVGFyZ2V0KTtcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgJ0Z1bmN0aW9uU2NoZWR1bGVJbml0aWFsaXphdGlvbkVycm9yJyxcbiAgICAgICAge1xuICAgICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gaW5zdGFudGlhdGUgc2NoZWR1bGUgZm9yIG5vZGVqcyBmdW5jdGlvbicsXG4gICAgICAgICAgcmVzb2x1dGlvbjogJ1NlZSB0aGUgdW5kZXJseWluZyBlcnJvciBtZXNzYWdlIGZvciBtb3JlIGRldGFpbHMuJyxcbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3IgYXMgRXJyb3JcbiAgICAgICk7XG4gICAgfVxuXG4gICAgVGFncy5vZihmdW5jdGlvbkxhbWJkYSkuYWRkKFRhZ05hbWUuRlJJRU5ETFlfTkFNRSwgaWQpO1xuXG4gICAgdGhpcy5mdW5jdGlvbkVudmlyb25tZW50VHJhbnNsYXRvciA9IG5ldyBGdW5jdGlvbkVudmlyb25tZW50VHJhbnNsYXRvcihcbiAgICAgIGZ1bmN0aW9uTGFtYmRhLFxuICAgICAgcHJvcHMuZW52aXJvbm1lbnQsXG4gICAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gICAgICBmdW5jdGlvbkVudmlyb25tZW50VHlwZUdlbmVyYXRvclxuICAgICk7XG5cbiAgICB0aGlzLnJlc291cmNlcyA9IHtcbiAgICAgIGxhbWJkYTogZnVuY3Rpb25MYW1iZGEsXG4gICAgICBjZm5SZXNvdXJjZXM6IHtcbiAgICAgICAgY2ZuRnVuY3Rpb246IGZ1bmN0aW9uTGFtYmRhLm5vZGUuZmluZENoaWxkKCdSZXNvdXJjZScpIGFzIENmbkZ1bmN0aW9uLFxuICAgICAgfSxcbiAgICB9O1xuXG4gICAgdGhpcy5zdG9yZU91dHB1dChvdXRwdXRTdG9yYWdlU3RyYXRlZ3kpO1xuXG4gICAgbmV3IEF0dHJpYnV0aW9uTWV0YWRhdGFTdG9yYWdlKCkuc3RvcmVBdHRyaWJ1dGlvbk1ldGFkYXRhKFxuICAgICAgU3RhY2sub2YodGhpcyksXG4gICAgICBmdW5jdGlvblN0YWNrVHlwZSxcbiAgICAgIGZpbGVVUkxUb1BhdGgobmV3IFVSTCgnLi4vcGFja2FnZS5qc29uJywgaW1wb3J0Lm1ldGEudXJsKSlcbiAgICApO1xuICB9XG5cbiAgYWRkRW52aXJvbm1lbnQgPSAoa2V5OiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcgfCBCYWNrZW5kU2VjcmV0KSA9PiB7XG4gICAgdGhpcy5mdW5jdGlvbkVudmlyb25tZW50VHJhbnNsYXRvci5hZGRFbnZpcm9ubWVudEVudHJ5KGtleSwgdmFsdWUpO1xuICB9O1xuXG4gIGdldFJlc291cmNlQWNjZXNzQWNjZXB0b3IgPSAoKSA9PiAoe1xuICAgIGlkZW50aWZpZXI6IGAke3RoaXMubm9kZS5pZH1MYW1iZGFSZXNvdXJjZUFjY2Vzc0FjY2VwdG9yYCxcbiAgICBhY2NlcHRSZXNvdXJjZUFjY2VzczogKFxuICAgICAgcG9saWN5OiBQb2xpY3ksXG4gICAgICBzc21FbnZpcm9ubWVudEVudHJpZXM6IFNzbUVudmlyb25tZW50RW50cnlbXVxuICAgICkgPT4ge1xuICAgICAgY29uc3Qgcm9sZSA9IHRoaXMucmVzb3VyY2VzLmxhbWJkYS5yb2xlO1xuICAgICAgaWYgKCFyb2xlKSB7XG4gICAgICAgIC8vIFRoaXMgc2hvdWxkIG5ldmVyIGhhcHBlbiBzaW5jZSB3ZSBhcmUgdXNpbmcgdGhlIEZ1bmN0aW9uIEwyIGNvbnN0cnVjdFxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgJ05vIGV4ZWN1dGlvbiByb2xlIGZvdW5kIHRvIGF0dGFjaCBsYW1iZGEgcGVybWlzc2lvbnMgdG8nXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBwb2xpY3kuYXR0YWNoVG9Sb2xlKHJvbGUpO1xuICAgICAgc3NtRW52aXJvbm1lbnRFbnRyaWVzLmZvckVhY2goKHsgbmFtZSwgcGF0aCB9KSA9PiB7XG4gICAgICAgIHRoaXMuZnVuY3Rpb25FbnZpcm9ubWVudFRyYW5zbGF0b3IuYWRkU3NtRW52aXJvbm1lbnRFbnRyeShuYW1lLCBwYXRoKTtcbiAgICAgIH0pO1xuICAgIH0sXG4gIH0pO1xuXG4gIC8qKlxuICAgKiBTdG9yZSBzdG9yYWdlIG91dHB1dHMgdXNpbmcgcHJvdmlkZWQgc3RyYXRlZ3lcbiAgICovXG4gIHByaXZhdGUgc3RvcmVPdXRwdXQgPSAoXG4gICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5OiBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5PEZ1bmN0aW9uT3V0cHV0PlxuICApOiB2b2lkID0+IHtcbiAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3kuYXBwZW5kVG9CYWNrZW5kT3V0cHV0TGlzdChmdW5jdGlvbk91dHB1dEtleSwge1xuICAgICAgdmVyc2lvbjogJzEnLFxuICAgICAgcGF5bG9hZDoge1xuICAgICAgICBkZWZpbmVkRnVuY3Rpb25zOiB0aGlzLnJlc291cmNlcy5sYW1iZGEuZnVuY3Rpb25OYW1lLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfTtcbn1cblxuY29uc3QgaXNXaG9sZU51bWJlckJldHdlZW5JbmNsdXNpdmUgPSAoXG4gIHRlc3Q6IG51bWJlcixcbiAgbWluOiBudW1iZXIsXG4gIG1heDogbnVtYmVyXG4pID0+IG1pbiA8PSB0ZXN0ICYmIHRlc3QgPD0gbWF4ICYmIHRlc3QgJSAxID09PSAwO1xuXG5leHBvcnQgdHlwZSBOb2RlVmVyc2lvbiA9IDE2IHwgMTggfCAyMDtcblxuY29uc3Qgbm9kZVZlcnNpb25NYXA6IFJlY29yZDxOb2RlVmVyc2lvbiwgUnVudGltZT4gPSB7XG4gIDE2OiBSdW50aW1lLk5PREVKU18xNl9YLFxuICAxODogUnVudGltZS5OT0RFSlNfMThfWCxcbiAgMjA6IFJ1bnRpbWUuTk9ERUpTXzIwX1gsXG59O1xuIl19